// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    InitializeCommonEvent(0, 90005620, 1038520570, 1038521570, 1038521571, 0, 1038522570, 1038522571, 1038522572);
    InitializeCommonEvent(0, 90005621, 1038520570, 1038521573);
    InitializeCommonEvent(0, 90005261, 1038520340, 1038522300, 1106247680, 0, -1);
    InitializeCommonEvent(1, 90005261, 1038520350, 1038522300, 1101004800, 0, -1);
    InitializeEvent(0, 1038522350, 0);
    InitializeEvent(0, 1038522347, 1038520340, 1038522400, 1038520800, 1038520350);
    InitializeEvent(1, 1038522347, 1038520350, 1038522400, 1038520800, 1038520340);
    InitializeCommonEvent(0, 90005870, 1038520340, 904950602, 24);
    InitializeCommonEvent(0, 90005860, 1038520800, 0, 1038520340, 0, 30385, 0);
    InitializeEvent(0, 1038522339, 1038520340, 1038520350);
    InitializeEvent(0, 1038522349, 0);
    InitializeCommonEvent(0, 90005616, 530385, 1038522700);
    InitializeEvent(0, 1038522346, 1038520340, 1038520800, 15302, 1038522320, 1038522340, 15310, 15311, 15312, 1038522343, 1038522344, 1038522345);
    InitializeEvent(0, 1038522343, 1038520340, 1038522340, 15310);
    InitializeEvent(1, 1038522343, 1038520340, 1038522341, 15311);
    InitializeEvent(2, 1038522343, 1038520340, 1038522342, 15312);
    InitializeEvent(0, 1038522344, 1038520800, 1038520340, 1038525230, 1038520350);
    InitializeEvent(0, 1038522345, 1038520340, 1038520350, 15335);
    InitializeCommonEvent(0, 90005211, 1038520200, 30016, 20016, 1038522200, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520201, 30016, 20016, 1038522200, 1092616192, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520205, 30016, 20016, 1038522205, 1092616192, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520206, 30016, 20016, 1038522205, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520210, 30016, 20016, 1038522210, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520215, 30016, 20016, 1038522215, 1092616192, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520216, 30016, 20016, 1038522215, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520220, 30016, 20016, 1038522220, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520221, 30016, 20016, 1038522221, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520222, 30016, 20016, 1038522221, 1092616192, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520225, 30016, 20016, 1038522225, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520226, 30016, 20016, 1038522225, 1092616192, 1053609165, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 1038520250, 1038522250, 1092616192, 0, -1);
    InitializeCommonEvent(0, 90005211, 1038520251, 30016, 20016, 1038522250, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520255, 30016, 20016, 1038522255, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520256, 30016, 20016, 1038522255, 1092616192, 1036831949, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005211, 1038520257, 30016, 20016, 1038522255, 1092616192, 1050253722, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520260, 30016, 20016, 1038522260, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520265, 30014, 20014, 1038522265, 1084227584, 0, 0, 0, 0, 0);
    InitializeCommonEvent(3, 90005211, 1038520266, 30014, 20014, 1038522265, 1084227584, 1053609165, 0, 0, 0, 0);
    InitializeCommonEvent(4, 90005211, 1038520267, 30014, 20014, 1038522265, 1084227584, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520270, 30016, 20016, 1038522270, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520280, 30014, 20014, 1038522280, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520281, 30014, 20014, 1038522280, 1092616192, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005211, 1038520282, 30014, 20014, 1038522280, 1092616192, 1058642330, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520285, 30014, 20014, 1038522285, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520286, 30014, 20014, 1038522285, 1092616192, 1056964608, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005211, 1038520287, 30014, 20014, 1038522285, 1092616192, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520290, 30014, 20014, 1038522290, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 1038520295, 30014, 20014, 1038522295, 1092616192, 0, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005211, 1038520296, 30014, 20014, 1038522295, 1092616192, 1056964608, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005211, 1038520297, 30014, 20014, 1038522295, 1092616192, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(0, 900005610, 1038521680, 100, 800, 1038528600);
    InitializeCommonEvent(0, 90005683, 62314, 1038521200, 211, 78392, 78392);
    //init boss reward
    InitializeEvent(0, 1038529990, 0);
});

//generic boss event
$Event(1038529990, Default, function() {
    WaitFor(CharacterDead(1038520340));
    //boss rewards (3 bonus items + guaranteed flag)
    InitializeCommonEvent(0,90001033,1049304212,1049304104,-1,-1,1049304903,1049304904,1049304905,1049304906,1049305518,1049305520,1049305523,1049305528,1049300212);
});

//prevent tibia mariner from dying when entering area
$Event(50, Restart, function() {
    SetEventFlagID(1038520340, OFF);
    SetEventFlagID(1038520800, OFF);
});

$Event(1038522339, Restart, function(X0_4, X4_4) {
    EndIf(EventFlag(1038520800));
    SetCharacterEventTarget(X0_4, X4_4);
    SetCharacterEventTarget(X4_4, X0_4);
    WaitFor(CharacterDead(X4_4));
    WaitFixedTimeSeconds(5);
    WaitFor(!CharacterDead(X4_4));
    RestartEvent();
});

$Event(1038522341, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4, X36_4, X40_4) {
    chr = CharacterDead(1038520340);
    EndIf(chr);
    if (chr) {
        DisableGenerator(X4_4);
        DisableGenerator(X8_4);
        DisableGenerator(X12_4);
        DisableGenerator(X16_4);
        DisableGenerator(X20_4);
        DisableGenerator(X24_4);
        ForceCharacterDeath(1038525230, false);
    }
L0:
    if (!EventFlag(1038522230)) {
        DisableGenerator(X4_4);
        DisableGenerator(X8_4);
        DisableGenerator(X12_4);
        DisableGenerator(X16_4);
        DisableGenerator(X20_4);
        DisableGenerator(X24_4);
        ForceCharacterDeath(1038525230, false);
    }
L1:
    WaitFor(CharacterHasSpEffect(X0_4, X28_4) && !CharacterDead(X0_4));
    if (CharacterHasSpEffect(X0_4, X32_4)) {
        EnableGenerator(X4_4);
        EnableGenerator(X16_4);
        EnableGenerator(X20_4);
        EnableGenerator(X24_4);
    }
L1:
    if (CharacterHasSpEffect(X0_4, X36_4)) {
        EnableGenerator(X8_4);
        EnableGenerator(X16_4);
        EnableGenerator(X20_4);
        EnableGenerator(X24_4);
    }
L2:
    if (CharacterHasSpEffect(X0_4, X40_4)) {
        EnableGenerator(X12_4);
        EnableGenerator(X16_4);
        EnableGenerator(X20_4);
        EnableGenerator(X24_4);
    }
L3:
    WaitFixedTimeSeconds(5);
    DisableGenerator(X4_4);
    DisableGenerator(X8_4);
    DisableGenerator(X12_4);
    DisableGenerator(X16_4);
    DisableGenerator(X20_4);
    DisableGenerator(X24_4);
    SetEventFlagID(1038522230, ON);
    RestartEvent();
});

$Event(1038522342, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4) {
    EndIf(EventFlag(1038520800));
    WaitFor(CharacterHasSpEffect(X0_4, X4_4));
    DisableCharacter(X0_4);
    DisableCharacterCollision(X0_4);
    SetEventFlagID(1038520340, OFF);
    RandomlySetEventFlagInRange(1038520340, 1038520341, ON);
    if (CharacterHasSpEffect(X0_4, X20_4)) {
        if (!EventFlag(1038520340)) {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X12_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        } else {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X16_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        }
        ForceAnimationPlayback(X0_4, 3022, true, false, false);
    } else if (CharacterHasSpEffect(X0_4, X24_4)) {
        if (!EventFlag(1038520341)) {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X8_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        } else {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X16_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        }
        ForceAnimationPlayback(X0_4, 3022, true, false, false);
    } else if (CharacterHasSpEffect(X0_4, X28_4)) {
        if (!EventFlag(1038520340)) {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X8_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        } else {
            WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X12_4, -1, X0_4);
            EnableCharacter(X0_4);
            EnableCharacterCollision(X0_4);
        }
        ForceAnimationPlayback(X0_4, 3022, true, false, false);
        Goto(L0);
    }
L0:
    RequestCharacterAIReplan(X0_4);
    WaitFixedTimeSeconds(1);
    RestartEvent();
});

$Event(1038522343, Restart, function(X0_4, X4_4, X8_4) {
    EndIf(EventFlag(1038520800));
    WaitFor(InArea(X0_4, X4_4) && CharacterHasSpEffect(X0_4, X8_4, Equal, 0));
    SetSpEffect(X0_4, X8_4);
    RestartEvent();
});

$Event(1038522344, Restart, function(X0_4, X4_4, X8_4, X12_4) {
    if (EventFlag(X0_4)) {
        DisableGenerator(1038523350);
        DisableCharacter(X8_4);
        DisableCharacterCollision(X8_4);
        ForceCharacterDeath(X8_4, false);
        DisableCharacter(X12_4);
        DisableCharacterCollision(X12_4);
        ForceCharacterDeath(X12_4, false);
        EndEvent();
    }
    WaitFor(CharacterDead(X4_4));
    WaitFor(mainGroupAbuse);
    SetNetworkconnectedEventFlagID(X0_4, ON);
    DisableGenerator(1038522230);
    DisableGenerator(1038522231);
    DisableGenerator(1038522232);
    DisableGenerator(1038522240);
    DisableGenerator(1038522241);
    DisableGenerator(1038522242);
    DisableGenerator(1038523350);
    ForceCharacterDeath(X8_4, false);
    WaitFixedTimeSeconds(15);
    DisableCharacter(X12_4);
    DisableCharacterCollision(X12_4);
    ForceCharacterDeath(X12_4, false);
    EndEvent();
});

$Event(1038522345, Restart, function(X0_4, X4_4, X8_4) {
    WaitFor(CharacterHPValue(X0_4) == 0);
    WaitFor(CharacterHasSpEffect(X4_4, X8_4));
    ForceCharacterDeath(X4_4, true);
    EndEvent();
});

$Event(1038522346, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4, X36_4, X40_4) {
    EndIf(EventFlag(X4_4));
    WaitFor(CharacterHasSpEffect(X0_4, X8_4));
    if (HPRatio(X0_4) <= 0.5) {
        SetNetworkconnectedEventFlagID(X16_4, ON);
    }
    GotoIf(L1, CharacterHasSpEffect(X0_4, X20_4));
    GotoIf(L2, CharacterHasSpEffect(X0_4, X24_4));
    GotoIf(L3, CharacterHasSpEffect(X0_4, X28_4));
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X12_4, -1, X0_4);
    Goto(L0);
L1:
    GotoIf(S0, EventFlag(X16_4));
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X36_4, -1, X0_4);
    Goto(L0);
S0:
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X40_4, -1, X0_4);
    Goto(L0);
L2:
    GotoIf(S1, EventFlag(X16_4));
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X32_4, -1, X0_4);
    Goto(L0);
S1:
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X40_4, -1, X0_4);
    Goto(L0);
L3:
    WarpCharacterAndCopyFloor(X0_4, TargetEntityType.Area, X36_4, -1, X0_4);
    Goto(L0);
L0:
    ForceAnimationPlayback(X0_4, 3022, true, false, false);
    RequestCharacterAIReplan(X0_4);
    WaitFixedTimeSeconds(5);
    RestartEvent();
});

$Event(1038522347, Restart, function(X0_4, X4_4, X8_4, X12_4) {
    DisableNetworkSync();
    EndIf(EventFlag(X8_4));
    WaitFor(CharacterTargetedBy(X0_4, 20000) && !InArea(20000, X4_4));
    ClearCharactersAITarget(X0_4);
    WaitFixedTimeSeconds(1);
    SetCharacterEventTarget(X0_4, X12_4);
    SetCharacterEventTarget(X12_4, X0_4);
    WaitFixedTimeSeconds(5);
    RestartEvent();
});

$Event(1038522349, End, function() {
    SetEventFlagID(1038520340, OFF);
    SetEventFlagID(1038520341, OFF);
    SetEventFlagID(1038520343, OFF);
    EndEvent();
});

$Event(1038522350, Restart, function() {
    SetSpEffect(1038520340, 8092);
    EndEvent();
});
