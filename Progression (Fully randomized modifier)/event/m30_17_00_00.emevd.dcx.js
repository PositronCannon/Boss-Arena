// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    RegisterBonfire(301700, 30171950, 0, 0, 0, 5);
    InitializeCommonEvent(0, 900005610, 30171150, 100, 800, 0);
    InitializeCommonEvent(0, 90005525, 30170570, 30171570);
    InitializeCommonEvent(0, 90005620, 30170560, 30171560, 30171561, 0, 30172560, 30172561, 30172562);
    InitializeCommonEvent(0, 90005621, 30170560, 30171563);
    InitializeCommonEvent(0, 90005620, 30170565, 30171565, 30171566, 0, 30172565, 30172566, 30172567);
    InitializeCommonEvent(0, 90005621, 30170565, 30171568);
    InitializeEvent(0, 30172400, 30170200);
    InitializeEvent(1, 30172400, 30170201);
    InitializeEvent(2, 30172400, 30170202);
    InitializeCommonEvent(0, 90005261, 30170223, 30172223, 1097859072, 0, 0);
    InitializeCommonEvent(0, 90005200, 30170200, 30002, 20002, 30172450, 1056964608, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005200, 30170201, 30002, 20002, 30172450, 0, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005261, 30170202, 30172450, 1088421888, 0, 0);
    InitializeEvent(3, 30172400, 30170204);
    InitializeEvent(4, 30172400, 30170205);
    InitializeEvent(5, 30172400, 30170206);
    InitializeCommonEvent(0, 90005200, 30170204, 30000, 20000, 30172204, 1082130432, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005200, 30170205, 30000, 20000, 30172204, 1080033280, 0, 0, 0, 0);
    InitializeCommonEvent(2, 90005200, 30170206, 30000, 20000, 30172204, 1082549862, 0, 0, 0, 0);
    InitializeEvent(6, 30172400, 30170210);
    InitializeEvent(7, 30172400, 30170211);
    InitializeEvent(8, 30172400, 30170219);
    InitializeCommonEvent(0, 90005250, 30170219, 30172315, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170219, 30172217, 0, 3005);
    InitializeCommonEvent(0, 90005200, 30170210, 30002, 20002, 30172210, 1084227584, 0, 0, 0, 0);
    InitializeCommonEvent(1, 90005200, 30170211, 30002, 20002, 30172210, 1085276160, 0, 0, 0, 0);
    InitializeEvent(9, 30172400, 30170215);
    InitializeEvent(0, 30172402, 30170216, 30172202);
    InitializeEvent(10, 30172400, 30170316);
    InitializeCommonEvent(0, 90005250, 30170215, 30172221, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170216, 30172201, 0, -1);
    InitializeEvent(0, 30172311, 0);
    InitializeCommonEvent(0, 90005250, 30170317, 30172318, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170316, 30172318, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170215, 30172214, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170300, 30172300, 0, -1);
    InitializeCommonEvent(1, 90005250, 30170301, 30172300, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170305, 30172305, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170306, 30172306, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170309, 30172309, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170310, 30172350, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170313, 30172310, 0, 3015);
    InitializeCommonEvent(0, 90005261, 30170314, 30172315, 1073741824, 0, -1);
    InitializeCommonEvent(1, 90005261, 30170315, 30172315, 1084227584, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170350, 30172315, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170201, 30172223, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170200, 30172223, 0, -1);
    InitializeCommonEvent(1, 90005250, 30170311, 30172353, 0, -1);
    InitializeCommonEvent(2, 90005250, 30170312, 30172353, 0, -1);
    InitializeCommonEvent(0, 90005200, 30170313, 30000, 20000, 30172353, 0, 0, 0, 0, 0);
    InitializeEvent(12, 30172400, 30170250);
    InitializeEvent(13, 30172400, 30170251);
    InitializeEvent(14, 30172400, 30170252);
    InitializeCommonEvent(1, 90005250, 30170250, 30172451, 0, -1);
    InitializeCommonEvent(1, 90005250, 30170251, 30172216, 0, 3025);
    InitializeCommonEvent(1, 90005250, 30170252, 30172450, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170351, 30172351, 0, -1);
    InitializeCommonEvent(0, 90005250, 30170351, 30172352, 0, -1);
    InitializeCommonEvent(0, 90005200, 30170350, 30001, 20001, 30172315, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005250, 30170352, 30172353, 0, -1);
    InitializeCommonEvent(0, 90005200, 30170450, 30000, 20000, 30172451, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005200, 30170400, 30000, 20000, 30172410, 0, 0, 0, 0, 0);
    InitializeEvent(11, 30172400, 30170400);
    InitializeCommonEvent(0, 90005300, 30170400, 30170400, 0, 0, 0);
    InitializeCommonEvent(0, 90005652, 30170540, 30171540, 30170400);
    InitializeCommonEvent(0, 90005651, 30170540, 30171540);
    InitializeEvent(0, 30172600, 0);
    InitializeCommonEvent(0, 90005501, 30170530, 30170531, 4, 30171530, 30171531, 30171532, 30170532);
    InitializeCommonEvent(0, 90005501, 30170510, 30171510, 1, 30171510, 30171511, 30171512, 30170511);
    InitializeCommonEvent(0, 90005501, 30170515, 30170516, 0, 30171515, 30171516, 30171517, 30170517);
    InitializeEvent(0, 30172510, 0);
    InitializeCommonEvent(0, 90005513, 30170542, 30171542, 30171543, 30173543, 27115, 0, 0);
    InitializeEvent(0, 30172520, 0);
    InitializeCommonEvent(0, 90005680, 30170500, 30170501, 30170502, 30170503, 30171500);
    InitializeCommonEvent(0, 90005680, 30170500, 30170501, 30170502, 30170503, 30171500);
    InitializeCommonEvent(0, 90005681, 30170500, 30170501, 30170502, 30170503, 30171500);
    InitializeEvent(0, 30172500, 0);
    InitializeEvent(0, 30172525, 0);
    InitializeEvent(0, 30172580, 0);
    InitializeEvent(0, 30172800, 0);
    InitializeEvent(0, 30172810, 0);
    InitializeEvent(0, 30172849, 0);
    InitializeEvent(0, 30122811, 0);
    InitializeCommonEvent(0, 90005646, 30170800, 30172840, 30172841, 30171840, 30172840, 4382);
    InitializeCommonEvent(0, 91005600, 30172800, 30171695, 5);
    InitializeEvent(0, 16002520, 30170620, 30171620);
    InitializeEvent(0, 30170050, 0);
});

$Event(50, Default, function() {
    InitializeEvent(0, 30170519, 0);
});

$Event(30170050, Default, function() {
    EndIf(ThisEventSlot());
    SetEventFlagID(30170500, ON);
});

$Event(30172250, Restart, function(X0_4, X4_4, X8_4) {
    EndIf(EventFlag(X0_4));
    DisableObjAct(X4_4, -1);
    if (EventFlag(X8_4)) {
        EnableObjAct(X4_4, -1);
        EndEvent();
    }
L0:
    WaitFor(PlayerIsInOwnWorld() && EventFlag(X8_4) && !EventFlag(X0_4));
    SetEventFlagID(X0_4, ON);
    EnableObjAct(X4_4, -1);
});

$Event(30172200, Restart, function(X0_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 17153);
    WaitFor(
        HasDamageType(X0_4, 0, DamageType.Unspecified)
            || (InArea(10000, 30172200)
                && ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
                    || CharacterType(10000, TargetType.Alive)
                    || CharacterType(10000, TargetType.GrayPhantom)
                    || CharacterType(10000, TargetType.WhitePhantom))));
    ClearSpEffect(X0_4, 17153);
    SetSpEffect(X0_4, 17152);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(30172311, Restart, function() {
    EndIf(ThisEventSlot());
    WaitFor(
        HasDamageType(30170316, 0, DamageType.Unspecified)
            || (InArea(10000, 30172316)
                && ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
                    || CharacterType(10000, TargetType.Alive)
                    || CharacterType(10000, TargetType.GrayPhantom)
                    || CharacterType(10000, TargetType.WhitePhantom))));
    ForceAnimationPlayback(30170316, 3004, false, true, false);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(30172400, Restart, function(X0_4) {
    if (!(CharacterDead(X0_4) || ThisEventSlot())) {
        SetSpEffect(X0_4, 5880);
        SetSpEffect(X0_4, 4320);
        DisableCharacterCollision(X0_4);
        WaitFor(
            InArea(X0_4, 30172405)
                || (InArea(X0_4, 30172406) && EventFlag(30170526))
                || (InArea(X0_4, 30172407) && EventFlag(30170521))
                || (InArea(X0_4, 30172408) && EventFlag(30170522)));
        SetThisEventSlot(ON);
        SetSpEffect(X0_4, 5881);
        SetSpEffect(X0_4, 4321);
        EnableCharacterCollision(X0_4);
        EndEvent();
    }
L0:
    SetSpEffect(X0_4, 5882);
    ClearSpEffect(X0_4, 5880);
    SetSpEffect(X0_4, 4321);
    EnableCharacterCollision(X0_4);
    EndEvent();
});

$Event(30172401, Restart, function(X0_4) {
    GotoIf(L0, CharacterDead(X0_4) || ThisEventSlot());
    SetSpEffect(X0_4, 10120);
    SetSpEffect(X0_4, 4320);
    EnableCharacterInvincibility(X0_4);
    DisableCharacterCollision(X0_4);
    WaitFor(
        InArea(X0_4, 30172405)
            || (InArea(X0_4, 30172406) && EventFlag(30170526))
            || (InArea(X0_4, 30172407) && EventFlag(30170521))
            || (InArea(X0_4, 30172408) && EventFlag(30170522)));
    ClearSpEffect(X0_4, 10120);
    SetSpEffect(X0_4, 4321);
    DisableCharacterInvincibility(X0_4);
    EnableCharacterCollision(X0_4);
    EndEvent();
});

$Event(30172402, Restart, function(X0_4, X4_4) {
    GotoIf(L0, chrFlagDmg);
    chrSp = CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710);
    chrFlagDmg = CharacterDead(X0_4) || ThisEventSlot() || HasDamageType(X0_4, 0, DamageType.Unspecified);
    EnableGenerator(30173216);
    WaitFixedTimeSeconds(4);
    SetSpEffect(X0_4, 10120);
    SetSpEffect(X0_4, 4320);
    EnableCharacterInvincibility(X0_4);
    DisableCharacterCollision(X0_4);
    chrSpAreaFlag |= chrSp
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom)
        || InArea(X0_4, 30172405);
    chrSpAreaFlag |= InArea(10000, X4_4) && chrSpAreaFlag && InArea(X0_4, 30172406) && EventFlag(30170526);
    chrSpAreaFlag |= InArea(X0_4, 30172407) && EventFlag(30170521);
    chrSpAreaFlag |= InArea(X0_4, 30172408) && EventFlag(30170522);
    WaitFor(chrSpAreaFlag);
    ClearSpEffect(X0_4, 10120);
    SetSpEffect(X0_4, 4321);
    DisableCharacterInvincibility(X0_4);
    EnableCharacterCollision(X0_4);
    EndEvent();
});

$Event(30172500, Default, function() {
    InitializeCommonEvent(0, 90005681, 30170500, 30170501, 30170502, 30170503, 30171500);
    if (EventFlag(57)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105070, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(56)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105060, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(55)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105050, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(54)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105040, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(53)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105030, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(52)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105020, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(51)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105010, 801105005, 101, 104, 100, 0);
    }
    if (EventFlag(50)) {
        InitializeCommonEvent(0, 90005682, 30170502, 30171500, 30172500, 30170500, 801105000, 801105005, 101, 104, 100, 0);
    }
});

$Event(30172501, Default, function(X0_4, X4_4, X8_4, X12_4, X16_4) {
    GotoIf(S0, EventFlag(30170504));
    GotoIf(L20, !EventFlag(30170504));
S0:
    GotoIf(L9, 
        ((EventFlag(X0_4) && EventFlag(X4_4)) || (!EventFlag(X0_4) && !EventFlag(X4_4)))
            && EventFlag(X12_4));
    if (EventFlag(X0_4)) {
        WaitFor(
            !EventFlag(X0_4)
                || (EventFlag(X4_4) && HasDamageType(X16_4, 20000, DamageType.Unspecified)));
        if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
            SetNetworkconnectedEventFlagID(X0_4, OFF);
            SetNetworkconnectedEventFlagID(X12_4, ON);
        }
        SetEventFlagID(X4_4, OFF);
        SetEventFlagID(X8_4, OFF);
        ForceAnimationPlayback(X16_4, 21, false, true, false);
        if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
            SetNetworkconnectedEventFlagID(X12_4, OFF);
        }
        RestartEvent();
    }
L0:
    WaitFor(
        EventFlag(X0_4) || (!EventFlag(X4_4) && HasDamageType(X16_4, 20000, DamageType.Unspecified)));
L20:
    SetEventFlagID(30170504, ON);
    if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
        SetNetworkconnectedEventFlagID(X0_4, ON);
        SetNetworkconnectedEventFlagID(X12_4, ON);
    }
    SetEventFlagID(X4_4, ON);
    ForceAnimationPlayback(X16_4, 12, false, true, false);
    if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
        SetNetworkconnectedEventFlagID(X12_4, OFF);
    }
    SetEventFlagID(X8_4, ON);
    RestartEvent();
L9:
    WaitFor(!EventFlag(X12_4));
    RestartEvent();
});

$Event(30172502, Default, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4, X36_4) {
    flagArea &= EventFlag(X0_4);
    if (X8_4 != 0) {
        flagArea &= InArea(10000, X8_4);
    }
    WaitFor(flagArea);
    CreateBulletOwner(X12_4);
    if (Signed(X24_4) != 0) {
        if (Signed(X16_4) != 0) {
            ShootBullet(X12_4, X4_4, X24_4, X16_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X24_4, 801105000, 0, 0, 0);
        }
        if (Signed(X20_4) != 0) {
            ShootBullet(X12_4, X4_4, X24_4, X20_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X24_4, 801105005, 0, 0, 0);
        }
    }
L1:
    if (Signed(X28_4) != 0) {
        if (Signed(X16_4) != 0) {
            ShootBullet(X12_4, X4_4, X28_4, X16_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X28_4, 801105000, 0, 0, 0);
        }
        if (Signed(X20_4) != 0) {
            ShootBullet(X12_4, X4_4, X28_4, X20_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X28_4, 801105005, 0, 0, 0);
        }
    }
L2:
    if (Signed(X32_4) != 0) {
        if (Signed(X16_4) != 0) {
            ShootBullet(X12_4, X4_4, X32_4, X16_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X32_4, 801105000, 0, 0, 0);
        }
        if (Signed(X20_4) != 0) {
            ShootBullet(X12_4, X4_4, X32_4, X20_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X32_4, 801105005, 0, 0, 0);
        }
    }
L3:
    if (Signed(X36_4) != 0) {
        if (Signed(X16_4) != 0) {
            ShootBullet(X12_4, X4_4, X36_4, X16_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X36_4, 801105000, 0, 0, 0);
        }
        if (Signed(X20_4) != 0) {
            ShootBullet(X12_4, X4_4, X36_4, X20_4, 0, 0, 0);
        } else {
            ShootBullet(X12_4, X4_4, X36_4, 801105005, 0, 0, 0);
        }
    }
L4:
    WaitFixedTimeSeconds(7.2);
    RestartEvent();
});

$Event(30172510, Default, function() {
    InitializeCommonEvent(0, 90005500, 30170510, 30171510, 1, 30171510, 30171511, 30173511, 30171512, 30173512, 30172511, 30172512, 30170511, 30172512, 0);
    InitializeCommonEvent(0, 90005500, 30170515, 30171516, 0, 30171515, 30171516, 30173516, 30171517, 30173517, 30172516, 30172517, 30170517, 30172517, 0);
    InitializeCommonEvent(0, 90005500, 30170530, 30170531, 4, 30171530, 30171531, 30173531, 30171532, 30173532, 30172531, 30172532, 30170532, 30172532, 0);
});

$Event(30170519, Default, function() {
    EndIf(ThisEventSlot());
    SetEventFlagID(30170530, ON);
    SetEventFlagID(30170510, ON);
    SetEventFlagID(30170515, ON);
});

$Event(30172520, Restart, function() {
    if (EventFlag(30170515)) {
        WaitFor(EventFlag(30170515));
        WaitFixedTimeSeconds(4);
        DeleteMapSFX(30172403, true);
        SetEventFlagID(30170522, OFF);
        WaitFixedTimeSeconds(6);
        SpawnMapSFX(30172402);
        SetEventFlagID(30170521, ON);
        WaitFor(!EventFlag(30170515));
    }
L0:
    WaitFixedTimeSeconds(3);
    DeleteMapSFX(30172402, true);
    SetEventFlagID(30170521, OFF);
    WaitFixedTimeSeconds(9);
    SpawnMapSFX(30172403);
    SetEventFlagID(30170522, ON);
    WaitFor(EventFlag(30170515));
    RestartEvent();
});

$Event(30172525, Restart, function() {
    WaitFor(EventFlag(30170500));
    WaitFixedTimeSeconds(3);
    SpawnMapSFX(30172401);
    SetEventFlagID(30170526, ON);
    WaitFor(!EventFlag(30170500));
    WaitFixedTimeSeconds(0.3);
    DeleteMapSFX(30172401, true);
    SetEventFlagID(30170526, OFF);
    RestartEvent();
});

$Event(30172580, Default, function() {
    RegisterLadder(30170580, 30170581, 30171580);
    RegisterLadder(30170582, 30170583, 30171582);
});

$Event(30172600, Restart, function() {
    EndIf(EventFlag(30170400));
    WaitFor(CharacterDead(30170400));
    SetEventFlagID(30170400, ON);
    EndEvent();
});

$Event(30172800, Restart, function() {
    EndIf(EventFlag(30170800));
    WaitFor(CharacterHPValue(30170800) <= 0);
    WaitFixedTimeSeconds(4);
    PlaySE(30170800, SoundType.SFX, 888880000);
    WaitFor(CharacterDead(30170800));
    HandleBossDefeatAndDisplayBanner(30170800, TextBannerType.EnemyFelled);
    //boss rewards (3 bonus items + guaranteed flag)
    InitializeCommonEvent(0,90001033,1049304220,1049304126,1049304122,-1,1049304943,1049304944,1049304945,1049304946,1049305623,1049305629,1049305631,1049305633,1049300220);
    WaitFixedTimeSeconds(6);
    WarpPlayer(11, 10, 0, 0, 11102021, 0);
});

$Event(30172810, Restart, function() {
    if (EventFlag(30170800)) {
        DisableCharacter(30170800);
        DisableCharacterCollision(30170800);
        ForceCharacterDeath(30170800, false);
        EndEvent();
    }
L0:
    DisableCharacterAI(30170800);
    WaitFor(EventFlag(30172805) && InArea(10000, 30172800));
L2:
    EnableCharacterAI(30170800);
    SetNetworkUpdateRate(30170800, true, CharacterUpdateFrequency.AlwaysUpdate);
    DisplayBossHealthBar(Enabled, 30170800, 0, 907100301);
});

$Event(30122811, Restart, function() {
    EndIf(EventFlag(30170800));
    WaitFor(HPRatio(30170800) <= 0.6);
    SetEventFlagID(30172802, ON);
});

$Event(30172849, Restart, function() {
    InitializeCommonEvent(0, 9005800, 30170800, 30171800, 30172800, 30172805, 30175800, 10000, 0, 0);
    InitializeCommonEvent(0, 9005801, 30170800, 30171800, 30172800, 30172805, 30172806, 10000);
    InitializeCommonEvent(0, 9005811, 30170800, 30171800, 3, 0);
    InitializeCommonEvent(0, 9005822, 30170800, 920200, 30172805, 30172806, 0, 30172802, 0, 0);
});

$Event(16002520, Restart, function(X0_4, X4_4) {
    if (!EventFlag(X0_4)) {
        WaitFor(PlayerIsInOwnWorld() && HasDamageType(X4_4, 20000, DamageType.Unspecified));
        SetNetworkconnectedEventFlagID(X0_4, ON);
        ForceAnimationPlayback(X4_4, 1, false, true, false);
    }
L0:
    DisableAsset(X4_4);
});
