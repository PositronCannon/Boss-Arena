// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    
    
    InitializeCommonEvent(0, 900005610, 41001510, 100, 800, 0);
    RegisterBonfire(41000000, 41001950, 0, 0, 0, 5);
    InitializeEvent(0, 41000800, 0);
    InitializeEvent(0, 41002810, 0);
    InitializeEvent(0, 41002811, 0);
    InitializeEvent(0, 41002849, 0);
    InitializeCommonEvent(0, 90005250, 41000200, 41002200, 0, 3033);
    InitializeCommonEvent(0, 90005221, 41000201, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005200, 41000203, 30001, 20001, 41002203, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005200, 41000204, 30001, 20001, 41002203, 1075838976, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005200, 41000205, 30001, 20001, 41002203, 1077936128, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005251, 41000211, 1104674816, 0, 0);
    InitializeCommonEvent(0, 90005251, 41000212, 1107296256, 1077936128, 0);
    InitializeCommonEvent(0, 90005250, 41000208, 41002208, 0, 3036);
    InitializeCommonEvent(0, 90005201, 41000209, 30001, 20001, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000215, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005200, 41000217, 30001, 20001, 41002217, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000219, 30001, 20001, 1077936128, 0);
    InitializeCommonEvent(0, 90005221, 41000220, 30001, 20001, 1077936128, 0);
    InitializeCommonEvent(0, 90005200, 41000222, 30007, 20007, 41002222, 0, 1, 0, 0, 0);
    InitializeEvent(0, 41002555, 41000222, 41001522);
    InitializeCommonEvent(0, 90005200, 41000225, 30007, 20007, 41002222, 0, 1, 0, 0, 0);
    InitializeEvent(1, 41002555, 41000225, 41001525);
    InitializeCommonEvent(0, 90005200, 41000226, 30007, 20007, 41002222, 0, 1, 0, 0, 0);
    InitializeEvent(2, 41002555, 41000226, 41001526);
    InitializeCommonEvent(0, 90005201, 41000231, 30000, 20000, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005201, 41000232, 30000, 20000, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005250, 41000233, 41002233, 0, 0);
    InitializeCommonEvent(0, 90005445, 41000308, 30000, 20000, 41002306, 1065353216, 0, 0, 0, 0, 41001308);
    InitializeCommonEvent(0, 90005446, 41000308, 30000, 20000, 1077936128, 0, 0, 0, 0, 0, 41001308);
    InitializeCommonEvent(0, 90005200, 41000255, 30000, 20000, 41002255, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 41000256, 30000, 20000, 41002310, 1088421888, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005445, 41000310, 30004, 20004, 41002310, 0, 0, 0, 0, 0, 41001310);
    InitializeCommonEvent(0, 90005200, 41000353, 30000, 20000, 41002353, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005251, 41000260, 1112014848, 1065353216, 0);
    InitializeCommonEvent(0, 90005251, 41000261, 1112014848, 0, 0);
    InitializeCommonEvent(0, 90005211, 41000311, 30000, 20000, 41002311, 1065353216, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005200, 41000314, 30000, 20000, 41002314, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 41000315, 41002315, 1086324736, 1088421888, -1);
    InitializeCommonEvent(0, 90005261, 41000316, 41002316, 1077936128, 0, -1);
    InitializeCommonEvent(0, 90005211, 41000317, 30003, 20003, 41002317, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 41000317, 41002317, 1077936128, 1073741824, 3003);
    InitializeCommonEvent(0, 90005211, 41000318, 30003, 20003, 41002317, 1077936128, 1067030938, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 41000318, 41002317, 1077936128, 1078774989, 3003);
    InitializeCommonEvent(0, 90005251, 41000244, 1065353216, 1065353216, 1700);
    InitializeCommonEvent(0, 90005250, 41000242, 41002242, 1065353216, 0);
    InitializeCommonEvent(0, 90005250, 41000243, 41002242, 1065353216, 0);
    InitializeCommonEvent(0, 90005250, 41000245, 41002242, 1065353216, 0);
    InitializeCommonEvent(0, 90005250, 41000246, 41002242, 1065353216, 0);
    InitializeCommonEvent(0, 90005445, 41000322, 30004, 20004, 41002322, 0, 0, 0, 0, 0, 41001322);
    InitializeCommonEvent(0, 90005445, 41000324, 30004, 20004, 41002324, 0, 0, 0, 0, 0, 41001324);
    InitializeCommonEvent(0, 90005251, 41000320, 1101004800, 0, 0);
    InitializeCommonEvent(0, 90005251, 41000321, 1101004800, 0, 0);
    InitializeCommonEvent(0, 90005251, 41000323, 1101004800, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000325, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005250, 41000342, 41002342, 1082130432, -1);
    InitializeEvent(0, 41002361, 0);
    InitializeCommonEvent(0, 90005200, 41000359, 30001, 20001, 41002359, 1045220557, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000268, 30022, 20052, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000269, 30022, 20052, 0, 0);
    InitializeCommonEvent(0, 90005221, 41000248, 30010, 20010, 0, 0);
    InitializeCommonEvent(0, 90005211, 41000327, 30003, 20003, 41002326, 1077936128, 1061997773, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 41000329, 30003, 20003, 41002326, 1077936128, 1067030938, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 41000341, 30003, 20003, 41002326, 1077936128, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005446, 41000330, 30004, 20004, 1090519040, 0, 0, 0, 0, 0, 41001330);
    InitializeCommonEvent(0, 90005251, 41000330, 1090519040, 1053609165, 3002);
    InitializeEvent(0, 41002360, 0);
    InitializeCommonEvent(0, 90005201, 41000360, 30001, 20001, 1093664768, 0, 0, 0, 0, 0);
    InitializeEvent(0, 41000500, 41000500, 41001500, 41002500);
    InitializeEvent(1, 41000500, 41000501, 41001501, 41002501);
    InitializeCommonEvent(0, 90005646, 41000800, 41002840, 41002841, 41001840, 41002840, 41);
    InitializeCommonEvent(0, 90005690, 41002600);
    InitializeCommonEvent(0, 90005691, 41002600);
    InitializeEvent(0, 41002610, 0);
    InitializeCommonEvent(0, 90005706, 41000700, 30021, 0);
});

$Event(50, Default, function() {
    EnableAssetInvunerability(41001303);
});

$Event(41000500, Restart, function(X0_4, X4_4, X8_4) {
    if (EventFlag(X0_4)) {
        DisableAsset(X4_4);
        EndEvent();
    }
L0:
    EnableAssetInvunerability(X4_4);
    WaitFor(
        InArea(10000, X8_4)
            && ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
                || CharacterType(10000, TargetType.Alive)
                || CharacterType(10000, TargetType.GrayPhantom)
                || CharacterType(10000, TargetType.WhitePhantom)));
    DisableAssetInvunerability(X4_4);
    SetEventFlagID(X0_4, ON);
    EndEvent();
});

$Event(41002555, Restart, function(X0_4, X4_4) {
    EndIf(ThisEventSlot());
    if (AssetDestroyed(X4_4, Equal, 1)) {
        WaitFor(CharacterHasSpEffect(X0_4, 9624));
        ForceAnimationPlayback(X0_4, 0, false, false, false);
        EnableCharacterAI(X0_4);
    }
    EndEvent();
    EnableAssetInvunerability(X4_4);
    EndIf(X0_4 == 0);
    WaitFor(CharacterHasSpEffect(X0_4, 9624));
    WaitFor(SpecialStandbyEndedFlag(X0_4) || !CharacterHasSpEffect(X0_4, 9624));
    DisableAssetInvunerability(X4_4);
});

$Event(41002360, Default, function() {
    EndIf(ThisEventSlot());
    DisableLockOnPoint(41000360, 220);
    WaitFor(
        (CharacterType(10000, TargetType.Alive) && InArea(10000, 41002360))
            || HPRatio(41000360) <= 0.9999
            || SpecialStandbyEndedFlag(41000360));
    SetNetworkconnectedThisEventSlot(ON);
    EnableLockOnPoint(41000360, 220);
    if (!SpecialStandbyEndedFlag(41000360)) {
        ForceAnimationPlayback(41000360, 20000, true, false, false);
    }
    WaitFixedTimeSeconds(0.5);
    if (!SpecialStandbyEndedFlag(41000372)) {
        ForceAnimationPlayback(41000372, 20000, true, false, false);
    }
    WaitFixedTimeSeconds(0.3);
    if (!SpecialStandbyEndedFlag(41000373)) {
        ForceAnimationPlayback(41000373, 20000, true, false, false);
    }
    WaitFixedTimeSeconds(0.7);
    if (!SpecialStandbyEndedFlag(41000371)) {
        ForceAnimationPlayback(41000371, 20000, true, false, false);
    }
    WaitFixedTimeSeconds(0.5);
    if (!SpecialStandbyEndedFlag(41000374)) {
        ForceAnimationPlayback(41000374, 20000, true, false, false);
    }
});

$Event(41002361, Default, function() {
    EndIf(ThisEventSlot());
    DisableLockOnPoint(41000359, 220);
    WaitFor(
        HPRatio(41000359) <= 0.9999
            || HPRatio(41000268) <= 0.9999
            || HPRatio(41000269) <= 0.9999
            || SpecialStandbyEndedFlag(41000359));
    SetNetworkconnectedThisEventSlot(ON);
    EnableLockOnPoint(41000359, 220);
    if (!SpecialStandbyEndedFlag(41000359)) {
        ForceAnimationPlayback(41000359, 20001, true, false, false);
    }
    if (!SpecialStandbyEndedFlag(41000268)) {
        ForceAnimationPlayback(41000268, 20052, true, false, false);
    }
    if (!SpecialStandbyEndedFlag(41000269)) {
        ForceAnimationPlayback(41000269, 20052, true, false, false);
    }
});

$Event(41002370, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4, X36_4, X40_4, X44_4) {
    EndIf(SpecialStandbyEndedFlag(X0_4));
    if (X24_4 != 0) {
        DisableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, false);
    }
    ForceAnimationPlayback(X0_4, X4_4, true, false, false);
    chrSp = (CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.BluePhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    if (0 != X12_4) {
        areaChrCmp |= InArea(10000, X12_4);
    }
    chrAreaCmp &= CharacterDead(X40_4) && EntityInRadiusOfEntity(10000, X0_4, X44_4, 1);
    areaChrCmp |= EntityInRadiusOfEntity(10000, X0_4, X16_4, 1) || chrAreaCmp;
    areaChrCmpSp &= areaChrCmp
        && CharacterBackreadStatus(X0_4)
        && (CharacterHasSpEffect(X0_4, 5080) || CharacterHasSpEffect(X0_4, 5450));
    chrAreaCmp &= X28_4 == 0 && X32_4 == 0 && X36_4 == 0;
    if (!chrAreaCmp) {
        if (X28_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.Combat);
        }
        if (X32_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.ActiveAlert);
        }
        if (X36_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.PassiveAlert);
        }
        areaChrCmpSp &= chr;
    }
L9:
    sp = CharacterHasSpEffect(X0_4, 481)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90110)
        && !CharacterHasSpEffect(X0_4, 90160);
    sp2 = CharacterHasSpEffect(X0_4, 482)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90120)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90162);
    sp3 = CharacterHasSpEffect(X0_4, 483)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90140)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90161);
    sp4 = CharacterHasSpEffect(X0_4, 484)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90130)
        && !CharacterHasSpEffect(X0_4, 90161)
        && !CharacterHasSpEffect(X0_4, 90162);
    sp5 = CharacterHasSpEffect(X0_4, 487)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90150)
        && !CharacterHasSpEffect(X0_4, 90160);
    areaChrCmpSp &= chrSp;
    WaitFor(
        areaChrCmpSp
            || HasDamageType(X0_4, 0, DamageType.Unspecified)
            || CharacterHasStateInfo(X0_4, 436)
            || CharacterHasStateInfo(X0_4, 2)
            || CharacterHasStateInfo(X0_4, 5)
            || CharacterHasStateInfo(X0_4, 6)
            || CharacterHasStateInfo(X0_4, 260)
            || sp
            || sp2
            || sp3
            || sp4
            || sp5);
    WaitFixedTimeSeconds(0.1);
    SetNetworkconnectedThisEventSlot(ON);
    SetSpecialStandbyEndedFlag(X0_4, ON);
    if (!(!CharacterHasSpEffect(X0_4, 5080) && !CharacterHasSpEffect(X0_4, 5450))) {
        WaitFixedTimeSeconds(X20_4);
        if (X24_4 != 0) {
            EnableCharacterGravity(X0_4);
            SetCharacterMaphit(X0_4, true);
        }
        ForceAnimationPlayback(X0_4, X8_4, true, false, false);
        EndEvent();
    }
L0:
    if (X24_4 != 0) {
        EnableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, true);
    }
    EndEvent();
});

$Event(41000800, Restart, function() {
    EndIf(EventFlag(41000800));
    WaitFor(CharacterHPValue(41000800) <= 0);
    WaitFixedTimeSeconds(4);
    PlaySE(41000800, SoundType.SFX, 888880000);
    WaitFor(CharacterDead(41000800));
    HandleBossDefeatAndDisplayBanner(41000800, TextBannerType.EnemyFelled);
    //roundtable warp
    WaitFixedTimeSeconds(6);
    WarpPlayer(11, 10, 0, 0, 11102021, 0);
});

$Event(41002810, Restart, function() {
    if (EventFlag(41000800)) {
        DisableCharacter(41000800);
        DisableCharacterCollision(41000800);
        ForceCharacterDeath(41000800, false);
        EndEvent();
    }
L0:
    DisableCharacterAI(41000800);
    WaitFor(EventFlag(41002805) && InArea(10000, 41002800));
    EnableCharacterAI(41000800);
    EnableCharacterCollision(41000800);
    SetNetworkUpdateRate(41000800, true, CharacterUpdateFrequency.AlwaysUpdate);
    DisplayBossHealthBar(Enabled, 41000800, 0, 905810410);
});

$Event(41002811, Restart, function() {
    EndIf(EventFlag(41000800));
    WaitFor(HPRatio(41000800) <= 0.7);
    SetEventFlagID(41002802, ON);
});

$Event(41002849, Restart, function() {
    InitializeCommonEvent(0, 9005800, 41000800, 41001800, 41002800, 41002805, 41005800, 10000, 0, 0);
    InitializeCommonEvent(0, 9005801, 41000800, 41001800, 41002800, 41002805, 41002806, 10000);
    InitializeCommonEvent(0, 9005811, 41000800, 41001800, 8, 0);
    InitializeCommonEvent(0, 9005822, 41000800, 941000, 41002805, 41002806, 0, 41002802, 1, 0);
});

$Event(41002610, Restart, function() {
    if (!EventFlag(41002601)) {
        WaitFor(InArea(10000, 41002610) || InArea(10000, 41002611) || EventFlag(41002601));
        if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
            SetNetworkconnectedEventFlagID(41002601, ON);
        }
        ForceAnimationPlayback(41001611, 0, false, false, true);
        ForceAnimationPlayback(41001610, 12, false, true, true);
        ForceAnimationPlayback(41001610, 20, false, true, true);
        ForceAnimationPlayback(41001610, 21, false, true, true);
        ForceAnimationPlayback(41001610, 10, false, true, true);
        WaitFor(
            (!AllPlayersInArea(41002610)
                && !AllPlayersInArea(41002611)
                && AssetBackread(41001610, Equal, 1))
                || !EventFlag(41002601));
        if (MapHasPermissionToUpdate(false, 0, 0, 0, 0)) {
            SetNetworkconnectedEventFlagID(41002601, OFF);
        }
        RestartEvent();
    }
L9:
    WaitFor(!EventFlag(41002601));
    RestartEvent();
});


