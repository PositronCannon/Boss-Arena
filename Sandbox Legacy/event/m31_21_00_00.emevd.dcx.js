// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    InitializeCommonEvent(0, 90001001, 0);
    RegisterBonfire(31210000, 31211950, 0, 0, 0, 5);
    InitializeEvent(0, 31212800, 0);
    InitializeEvent(0, 31212810, 0);
    InitializeEvent(0, 31212815, 0);
    InitializeEvent(0, 31032849, 0);
    InitializeEvent(0, 312112811, 0);
    InitializeEvent(0, 31212830, 31210801, 31210100);
    InitializeEvent(0, 31212860, 0);
    InitializeCommonEvent(0, 900005610, 31211200, 100, 800, 0);
    InitializeCommonEvent(0, 900005610, 31211201, 100, 800, 0);
    InitializeCommonEvent(0, 90005261, 31210800, 31212810, 1092616192, 0, 0);
    InitializeEvent(0, 31212500, 0);
    InitializeCommonEvent(0, 90005646, 31210800, 31212840, 31212841, 31211840, 31212840, 5407);
    InitializeCommonEvent(0, 90005511, 31210560, 31211560, 31213560, 27043, 0);
    InitializeCommonEvent(0, 90005512, 31210560, 31212560, 31212561);
    InitializeEvent(0, 31212400, 31210600, 31211600, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(1, 31212400, 31210600, 31211602, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(2, 31212400, 31210600, 31211604, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(3, 31212400, 31210600, 31211606, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(4, 31212400, 31210600, 31211608, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(5, 31212400, 31210600, 31211610, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(6, 31212400, 31210600, 31211612, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(7, 31212400, 31210600, 31211614, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(8, 31212400, 31210600, 31211616, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(9, 31212400, 31210600, 31211618, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(10, 31212400, 31210600, 31211620, 31211601, 31213601, 27080, 0, 0);
    InitializeEvent(11, 31212400, 31210600, 31211622, 31211601, 31213601, 27080, 0, 0);
    InitializeCommonEvent(0, 90005621, 1047380570, 31211578);
});

$Event(50, Default, function() {
    InitializeEvent(0, 31212205, 0);
    InitializeCommonEvent(0, 90005211, 31210209, 30000, 20000, 31212209, 0, 1065353216, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210210, 31212209, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210219, 31212219, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210220, 31212219, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210221, 31212219, 1073741824, 0, 0);
    InitializeEvent(0, 31212230, 31210227);
    InitializeEvent(1, 31212230, 31210228);
    InitializeEvent(2, 31212230, 31210229);
    InitializeEvent(3, 31212230, 31210230);
    InitializeEvent(4, 31212230, 31210231);
    InitializeEvent(5, 31212230, 31210232);
    InitializeEvent(6, 31212230, 31210233);
    InitializeEvent(7, 31212230, 31210234);
    InitializeEvent(8, 31212230, 31210235);
    InitializeEvent(9, 31212230, 31210236);
    InitializeEvent(10, 31212230, 31210237);
    InitializeEvent(11, 31212230, 31210238);
    InitializeEvent(12, 31212230, 31210239);
    InitializeEvent(13, 31212230, 31210275);
    InitializeEvent(14, 31212230, 31210276);
    InitializeEvent(15, 31212230, 31210277);
    InitializeEvent(0, 31212250, 31210250, 30008, 20008, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(1, 31212250, 31210251, 30005, 20005, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(2, 31212250, 31210253, 30008, 20008, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(3, 31212250, 31210255, 30005, 20005, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(17, 31212250, 31210282, 30005, 20005, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(18, 31212250, 31210283, 30005, 20005, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(0, 31212260, 31210254, 31212253, 31213254);
    InitializeCommonEvent(0, 90005201, 31210258, 30002, 20002, 1082130432, 0, 0, 0, 0, 0);
    InitializeEvent(4, 31212250, 31210259, 30008, 20008, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(5, 31212250, 31210260, 30005, 20005, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(6, 31212250, 31210261, 30005, 20005, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(7, 31212250, 31210262, 30008, 20008, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(8, 31212250, 31210263, 30005, 20005, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(1, 31212260, 31210264, 31212259, 31213264);
    InitializeEvent(9, 31212250, 31210265, 30005, 20005, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(10, 31212250, 31210266, 30005, 20005, 31212259, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(11, 31212250, 31210268, 30008, 20008, 31212268, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(12, 31212250, 31210269, 30005, 20005, 31212268, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(13, 31212250, 31210270, 30005, 20005, 31212268, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(14, 31212250, 31210278, 30008, 20008, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(2, 31212260, 31210279, 31212253, 31213279);
    InitializeEvent(15, 31212250, 31210280, 30008, 20008, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeEvent(16, 31212250, 31210281, 30005, 20005, 31212253, 0, 0, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210301, 31212300, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210305, 31212305, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210316, 31212316, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210317, 31212316, 1073741824, 0, 0);
    InitializeCommonEvent(0, 90005261, 31210318, 31212316, 1073741824, 0, 0);
    InitializeEvent(0, 31212308, 31210306, 31212306);
    InitializeEvent(1, 31212308, 31210307, 31212307);
    InitializeCommonEvent(0, 90005261, 31210330, 31212316, 1073741824, 0, 0);
});

$Event(31212500, Restart, function() {
    if (EventFlag(31210500)) {
        DisableAsset(31211500);
        EndEvent();
    }
L0:
    WaitFor(InArea(10000, 31212500));
    RequestAssetDestruction(31211500, 1);
    SetNetworkconnectedEventFlagID(31210500, ON);
});

$Event(31212205, Restart, function() {
    EndIf(ThisEventSlot());
    DisableCharacterAI(31210205);
    chrSp = (CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    chrSpArea = chrSp && InArea(10000, 31212205);
    chrSpArea2 = chrSp && InArea(10000, 31212204);
    WaitFor(chrSpArea || chrSpArea2);
    GotoIf(L1, chrSpArea.Passed);
    GotoIf(L2, chrSpArea2.Passed);
    Goto(L10);
L1:
    WaitFixedTimeSeconds(1);
    ChangeCharacterPatrolBehavior(31210205, 31213205);
    Goto(L10);
L2:
    Goto(L10);
L10:
    EnableCharacterAI(31210205);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(31212210, Restart, function(X0_4) {
    SetSpEffect(X0_4, 90000);
});

$Event(31212230, Restart, function(X0_4) {
    ForceCharacterDeath(X0_4, false);
});

$Event(31212250, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4, X36_4, X40_4) {
    EndIf(SpecialStandbyEndedFlag(X0_4));
    if (X24_4 != 0) {
        DisableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, false);
    }
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    ForceAnimationPlayback(X0_4, X4_4, true, false, false);
    chrSp = (CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    if (0 != X12_4) {
        area |= InArea(10000, X12_4);
    }
    area |= EntityInRadiusOfEntity(10000, X0_4, X16_4, 1);
    areaChrSpFlag &= area
        && CharacterBackreadStatus(X0_4)
        && (CharacterHasSpEffect(X0_4, 5080) || CharacterHasSpEffect(X0_4, 5450));
    if (!(X28_4 == 0 && X32_4 == 0 && X36_4 == 0)) {
        if (X28_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.Combat);
        }
        if (X32_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.ActiveAlert);
        }
        if (X36_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.PassiveAlert);
        }
        areaChrSpFlag &= chr;
    }
L9:
    areaChrSpFlag &= chrSp && EventFlag(31210600);
    WaitFor(areaChrSpFlag);
    WaitFixedTimeSeconds(0.1);
    SetNetworkconnectedThisEventSlot(ON);
    SetSpecialStandbyEndedFlag(X0_4, ON);
    if (!(!CharacterHasSpEffect(X0_4, 5080) && !CharacterHasSpEffect(X0_4, 5450))) {
        WaitFixedTimeSeconds(X20_4);
        if (X24_4 != 0) {
            EnableCharacterGravity(X0_4);
            SetCharacterMaphit(X0_4, true);
        }
        ForceAnimationPlayback(X0_4, X8_4, true, false, false);
        ChangeCharacterPatrolBehavior(X0_4, X40_4);
        ClearSpEffect(X0_4, 8082);
        EndEvent();
    }
L0:
    if (X24_4 != 0) {
        EnableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, true);
    }
    EndEvent();
});

$Event(31212260, Restart, function(X0_4, X4_4, X8_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    WaitFor(
        ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && InArea(10000, X4_4)
            && EventFlag(31210600));
    ClearSpEffect(X0_4, 8082);
    ChangeCharacterPatrolBehavior(X0_4, X8_4);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(31212308, Restart, function(X0_4, X4_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    SetSpEffect(X0_4, 5000);
    WaitFor(
        CharacterHasStateInfo(X0_4, 436)
            || CharacterHasStateInfo(X0_4, 2)
            || CharacterHasStateInfo(X0_4, 5)
            || CharacterHasStateInfo(X0_4, 6)
            || CharacterHasStateInfo(X0_4, 260)
            || (((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
                || CharacterType(10000, TargetType.Alive)
                || CharacterType(10000, TargetType.GrayPhantom)
                || CharacterType(10000, TargetType.WhitePhantom))
                && EntityInRadiusOfEntity(X0_4, 10000, 2, 1))
            || CharacterAIState(X0_4, AIStateType.Combat)
            || HasDamageType(X0_4, 0, DamageType.Unspecified)
            || InArea(X0_4, X4_4));
    ClearSpEffect(X0_4, 8081);
    ClearSpEffect(X0_4, 8082);
    ClearSpEffect(X0_4, 5000);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(31212400, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4) {
    if (EventFlag(X0_4)) {
        DisableObjAct(X8_4, X16_4);
        ReproduceAssetAnimation(X4_4, X24_4);
        EndEvent();
    }
L0:
    WaitFor(PlayerIsInOwnWorld() && !EventFlag(X0_4) && ObjActEventFlag(X12_4));
    SetNetworkconnectedEventFlagID(X0_4, ON);
    DisableObjAct(X8_4, X16_4);
    ForceAnimationPlayback(X4_4, X20_4, false, false, false);
});

$Event(31212800, Restart, function() {
    EndIf(EventFlag(31210800));
    WaitFor(CharacterHPValue(31210800) <= 0);
    WaitFixedTimeSeconds(4);
    PlaySE(31210800, SoundType.SFX, 888880000);
    WaitFor(CharacterDead(31210800));
    HandleBossDefeatAndDisplayBanner(31210800, TextBannerType.EnemyFelled);
    WaitFixedTimeSeconds(6);
    WarpPlayer(11, 10, 0, 0, 11102021, -11100);
});

$Event(31212810, Restart, function() {
    if (EventFlag(31210800)) {
        DisableCharacter(31210800);
        DisableCharacterCollision(31210800);
        ForceCharacterDeath(31210800, false);
        EndEvent();
    }
L0:
    if (!EventFlag(31210801)) {
        WaitFor(
            ((HasDamageType(31210800, 10000, DamageType.Unspecified)
                || CharacterAIState(31210800, AIStateType.Combat))
                && InArea(10000, 31212805)
                && PlayerIsInOwnWorld())
                || InArea(10000, 31212801));
        SetNetworkconnectedEventFlagID(31210801, ON);
    } else {
L1:
        WaitFor(
            ((HasDamageType(31210800, 10000, DamageType.Unspecified)
                || CharacterAIState(31210800, AIStateType.Combat))
                && InArea(10000, 31212805)
                && EventFlag(31212805))
                || InArea(10000, 31212801));
    }
L2:
    SetNetworkUpdateRate(31210800, true, CharacterUpdateFrequency.AlwaysUpdate);
    DisplayBossHealthBar(Enabled, 31210800, 0, 903400310);
});

$Event(312112811, Restart, function() {
    EndIf(EventFlag(31210800));
    WaitFor(HPRatio(31210800) <= 0.6);
    SetEventFlagID(31212852, ON);
});

$Event(31212815, Restart, function() {
    if (!EventFlag(31210800)) {
        WaitFixedTimeFrames(1);
        if (31210801 != 0) {
            GotoIf(L0, EventFlag(31210801));
            WaitFor(
                ((EventFlagState(ON, TargetEventFlagType.EventIDSlotNumber, 31212810)
                    || EventFlag(31210801))
                    && PlayerIsInOwnWorld())
                    || EventFlag(31210800));
            RestartIf(EventFlag(31210800));
            Goto(L1);
        }
L0:
        if (PlayerIsInOwnWorld()) {
            WaitFor(
                EventFlag(31210800)
                    || (PlayerIsInOwnWorld()
                        && !EventFlag(31210800)
                        && ActionButtonInArea(10000, 31211800)));
            GotoIf(L2, !PlayerIsInOwnWorld());
            RestartIf(EventFlag(31210800));
            SuppressSoundForFogGate(5);
            if (!CharacterHasSpEffect(10000, 4250)) {
                RotateCharacter(10000, 31212800, 60060, true);
            } else {
                RotateCharacter(10000, 31212800, 60060, false);
            }
        }
L3:
        GotoIf(L1, EventFlag(31212805));
        time = ElapsedSeconds(3);
        WaitFor(
            ((InArea(10000, 31212800) || time) && PlayerIsInOwnWorld() && !EventFlag(31210800))
                || EventFlag(31210800));
        RestartIf(EventFlag(31210800));
        RestartIf(time.Passed);
L1:
        if (PlayerIsInOwnWorld()) {
            if (!EventFlag(31210801)) {
                IssueBossRoomEntryNotification();
            }
            SetNetworkUpdateAuthority(31215800, AuthorityLevel.Forced);
        }
L2:
        ActivateMultiplayerdependantBuffs(31215800);
        SetNetworkconnectedEventFlagID(31212805, ON);
        EndIf(!PlayerIsInOwnWorld());
        RestartEvent();
    }
L10:
    EndIf(!PlayerIsInOwnWorld());
    WaitFor(
        PlayerIsInOwnWorld()
            && EventFlag(31210800)
            && (HasMultiplayerState(MultiplayerState.Invasion)
                || HasMultiplayerState(MultiplayerState.InvasionPending))
            && ActionButtonInArea(10000, 31211800));
    RotateCharacter(10000, 31212800, 60060, true);
    SendInvadingPhantomsHome(0);
    RestartEvent();
});

$Event(31212860, Restart, function() {
    EndIf(EventFlag(31210800));
    WaitFor(
        EventFlag(31212805)
            && (HasDamageType(31210800, 10000, DamageType.Unspecified)
                || CharacterAIState(31210800, AIStateType.Combat)
                || CharacterHasStateInfo(31210800, 436)
                || CharacterHasStateInfo(31210800, 2)
                || CharacterHasStateInfo(31210800, 5)
                || CharacterHasStateInfo(31210800, 6)
                || CharacterHasStateInfo(31210800, 260))
            && InArea(10000, 31212805)
            && PlayerIsInOwnWorld());
    SetNetworkconnectedEventFlagID(31212865, ON);
    IssueBossRoomEntryNotification();
});

$Event(31212830, Restart, function(X0_4, X4_4) {
    EndIf(EventFlag(X0_4));
    SetSpEffect(X4_4, 9531);
    WaitForEventFlag(ON, TargetEventFlagType.EventFlag, X0_4);
    SetSpEffect(X4_4, 9532);
});

$Event(31032849, Restart, function() {
    InitializeCommonEvent(0, 9005801, 31210800, 31211800, 31212800, 31212865, 31212806, 10000);
    InitializeCommonEvent(0, 9005811, 31210800, 31211800, 3, 31210801);
    InitializeCommonEvent(0, 9005811, 31210800, 31211801, 3, 31210801);
    InitializeCommonEvent(0, 9005822, 31210800, 931000, 31212805, 31212806, 31212810, 31212852, 31212802, 0);
});


