// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    //inform player how to start dane fight
    InitializeEvent(0,2049442807, 0);
    RegisterBonfire(2049440000, 2049441950, 0, 0, 0, 5);
    RegisterBonfire(2049440001, 2049441951, 0, 0, 0, 5);
    InitializeEvent(0, 2049442800, 0);
    InitializeEvent(0, 2049442801, 0);
    InitializeEvent(0, 2049442802, 0);
    InitializeCommonEvent(0, 90005221, 2049440213, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440217, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440221, 30005, 20005, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440223, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440225, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440226, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440227, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440228, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440229, 30005, 20005, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440230, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440233, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440234, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440235, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440236, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440237, 30005, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440238, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440239, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440240, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440241, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440242, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440243, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440244, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440245, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440246, 30001, 20001, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440247, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440248, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440249, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440250, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440251, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440252, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440253, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440254, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440256, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440257, 30000, 20000, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440262, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440285, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440286, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440287, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440288, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440289, 30002, 20002, 0, 0);
    InitializeCommonEvent(0, 90005221, 2049440290, 30002, 20002, 0, 0);
    InitializeEvent(0, 2049442580, 0);
    InitializeCommonEvent(0, 90005638, 2049440600, 2049441600, 2049441601);
    InitializeCommonEvent(0, 900005580, 580600, 2049441500, 9146);
    InitializeEvent(0, 2049440701, 2049440700, 4560, 4563, 4565, 90100, 4909, 2049442703, 2049442700, 2049442810);
    InitializeEvent(0, 2049440700, 2049440700, 2049449210);
    InitializeEvent(0, 2049440702, 2049440800, 2049449211, 4909);
    InitializeEvent(0, 2049440703, 2049449211, 2049442703, 4909);
    InitializeEvent(0, 2049440704, 2049442702, 2049449200, 4909, 2049449205);
    InitializeCommonEvent(0, 90005749, 2049440701, 2049440700, 4565, 2049442700);
    InitializeCommonEvent(0, 90005750, 2049441730, 4350, 107300, 400730, 400730, 2049449211, 6102);
    InitializeEvent(0, 2049440705, 2049441740, 206023, 1030052, 1106247680, 4922, 2049442810);
    InitializeEvent(0, 2049440706, 2049440700, 2049442708, 4565, 4909);
});

//inform player how to start dane fight and give gesture
$Event(2049442807, Default, function() {
    EndIf(!EventFlag(1049308195));
    DisplayBlinkingMessage(80865);
    AwardGesture(111);
});

$Event(2049442800, Restart, function() {
    EndIf(EventFlag(2049440800));
    EndIf(!PlayerIsInOwnWorld());
    WaitFor(CharacterDead(2049440710) && EventFlag(2049442810));
    WaitFixedTimeSeconds(3);
    HandleBossDefeatAndDisplayBanner(2049440710, TextBannerType.EnemyFelled);
    DeactivateGparamOverride(10);
    SetNetworkconnectedEventFlagID(2049440800, ON);
    //boss rewards (4 bonus items + guaranteed flag)
    InitializeCommonEvent(0,90001034,1049304275,-1,-1,-1,1049307231,1049307232,1049307233,1049307234,1049307235,1049306395,1049306401,1049306403,1049306406,1049306408,1049300275);
    WaitFixedTimeSeconds(6);
    WarpPlayer(11, 10, 0, 0, 11102021, 0);
});

$Event(2049442801, Restart, function() {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(2049440800));
    EndIf(EventFlag(2049440801));
    WaitFor(
        !HasMultiplayerState(MultiplayerState.MultiplayerPending)
            && HasMultiplayerState(MultiplayerState.Singleplayer)
            && EventFlag(2049442702));
    RestartIf(
        HasMultiplayerState(MultiplayerState.Multiplayer)
            || HasMultiplayerState(MultiplayerState.MultiplayerPending));
    SetSpEffect(10000, 514);
    WaitFixedTimeSeconds(1.5);
    SetNetworkconnectedEventFlagID(2049440801, ON);
    WarpCharacterAndCopyFloorWithFadeout(10000, TargetEntityType.Area, 2049442720, -1, 10000, true, true);
    EndEvent();
});

$Event(2049442802, Restart, function() {
    if (EventFlag(2049440800)) {
        DisableCharacter(2049440710);
        DisableCharacterCollision(2049440710);
        ForceCharacterDeath(2049440710, false);
        DisableAsset(2049441720);
        EndEvent();
    }
L0:
    DisableCharacter(2049440710);
    DisableCharacterCollision(2049440710);
    DisableCharacterAI(2049440710);
    DisableAsset(2049441720);
    EndIf(!EventFlag(2049440801));
    EndIf(!PlayerIsInOwnWorld());
    WaitFixedTimeFrames(1);
    SetCameraAngle(27.52, -55.2);
    DisableCharacter(2049445810);
    SetEventFlagID(2049442810, ON);
    SetSpEffect(10000, 190);
    ActivateGparamOverride(0, 0);
    ChangeWeather(Weather.PuffyClouds, -1, false);
    DisableCharacter(2049445800);
    DisableCharacterCollision(2049445800);
    DisableCharacterAI(2049445800);
    DisableCharacterHPBarDisplay(2049440710);
    SetNetworkconnectedEventFlagID(2049440801, OFF);
    SetSpEffect(10000, 514);
    EnableAsset(2049441720);
    WarpAssetToCharacter(2049441720, 2049441801, 100);
    CreateAssetfollowingSFX(2049441720, 200, 806700);
    EnableCharacter(2049440710);
    IssueShortWarpRequest(2049440710, TargetEntityType.Area, 2049442822, -1);
    EnableCharacterCollision(2049440710);
    WaitFor(
        EntityInRadiusOfEntity(10000, 2049440710, 10, 1)
            || ElapsedSeconds(5)
            || HasDamageType(2049440710, 10000, DamageType.Unspecified)
            || HasDamageType(2049440710, 0, DamageType.Unspecified));
    SetEventFlagID(1099002100, OFF);
    EnableCharacterAI(2049440710);
    SetNetworkUpdateRate(2049440710, true, CharacterUpdateFrequency.AlwaysUpdate);
    SetEventFlagID(2049442805, ON);
    WaitFixedTimeSeconds(1);
    DisplayBossHealthBar(Enabled, 2049440710, 0, 142501);
});

$Event(2049442805, Restart, function() {
    DisableNetworkSync();
    if (EventFlag(2049440800)) {
        EndEvent();
    }
L0:
    WaitFor(EventFlag(2049442805));
    WaitFixedTimeFrames(1);
    WaitFor(EventFlag(2049442802) || EventFlag(2049440800));
    if (!EventFlag(2049440800)) {
        WaitFixedTimeFrames(1);
        WaitFor(EventFlag(2049440800));
    }
L1:
    SetBossBGM(925000, BossBGMState.Stop1);
});

$Event(2049442580, Default, function() {
    RegisterLadder(2049440580, 2049440581, 2049441580);
});

$Event(2049440700, Restart, function(X0_4, X4_4) {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(X4_4));
    WaitFor(EntityInRadiusOfEntity(X0_4, 10000, 7, 1));
    SetEventFlagID(X4_4, ON);
    EndEvent();
});

$Event(2049440701, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4) {
    DisableNetworkSync();
    WaitFixedTimeFrames(1);
    WaitFixedTimeFrames(1);
    if (PlayerIsInOwnWorld()) {
    }
L10:
    DisableCharacter(X0_4);
    SetCharacterBackreadState(X0_4, true);
    if (!(EventFlag(X12_4) && !EventFlag(X20_4) && !EventFlag(X24_4))) {
        WaitFor(EventFlag(X12_4) && !EventFlag(X20_4) && !EventFlag(X24_4));
        RestartEvent();
    }
L0:
    GotoIf(L1, EventFlag(X4_4));
    GotoIf(L4, EventFlag(X8_4));
    Goto(L20);
L1:
    if (!EventFlag(X32_4)) {
        if (!EventFlag(X28_4)) {
            EnableCharacter(X0_4);
            SetCharacterBackreadState(X0_4, false);
            WaitFor(CharacterBackreadStatus(X0_4));
            ResetCharacterPosition(X0_4);
            SetCharacterTeamType(X0_4, TeamType.Disabled);
            ForceAnimationPlayback(X0_4, X16_4, true, false, false);
        }
    }
    WaitFixedTimeRealFrames(1);
    Goto(L20);
L4:
    Goto(L20);
L20:
    WaitFor(!(EventFlag(X12_4) && !EventFlag(X20_4) && !EventFlag(X24_4)));
    RestartEvent();
});

$Event(2049440702, Restart, function(X0_4, X4_4, X8_4) {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(X4_4));
    EndIf(EventFlag(X8_4));
    if (EventFlag(X0_4)) {
        SetEventFlagID(X4_4, ON);
    }
    EndEvent();
});

$Event(2049440703, Restart, function(X0_4, X4_4, X8_4) {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(X8_4));
    WaitFixedTimeFrames(1);
    if (EventFlag(X0_4)) {
        SetEventFlagID(X4_4, ON);
    }
    EndEvent();
});

$Event(2049440704, Restart, function(X0_4, X4_4, X8_4, X12_4) {
    EndIf(!PlayerIsInOwnWorld());
    EndIf(EventFlag(X8_4));
    WaitForEventFlag(ON, TargetEventFlagType.EventFlag, X0_4);
    if (!(HasMultiplayerState(MultiplayerState.Multiplayer)
        || HasMultiplayerState(MultiplayerState.MultiplayerPending))) {
        EndEvent();
    }
L0:
    SetEventFlagID(X0_4, ON);
    if (!EventFlag(X4_4)) {
        SetEventFlagID(X12_4, ON);
    }
    EndEvent();
});

$Event(2049440705, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4) {
    EndIf(!PlayerIsInOwnWorld());
    WaitFixedTimeFrames(2);
    EndIf(EventFlag(X20_4));
    WaitFor(ActionButtonInArea(X4_4, X0_4));
    DisplayGenericDialog(X8_4, PromptType.YESNO, NumberofOptions.NoButtons, 0, X12_4);
    SetEventFlagID(X16_4, ON);
    WaitFixedTimeSeconds(1);
    RestartEvent();
});

$Event(2049440706, Restart, function(X0_4, X4_4, X8_4, X12_4) {
    DisableNetworkSync();
    EndIf(!PlayerIsInOwnWorld());
    WaitFor(EventFlag(X8_4));
    WaitFixedTimeRealFrames(1);
    EndIf(EventFlag(X12_4));
    GotoIf(L1, !EventFlag(X4_4));
    Goto(L2);
L1:
    WaitFor(EntityInRadiusOfEntity(X0_4, 10000, 2.6, 1));
    SetEventFlagID(X4_4, ON);
    RestartEvent();
L2:
    WaitFor(!EntityInRadiusOfEntity(X0_4, 10000, 2.6, 1));
    SetEventFlagID(X4_4, OFF);
    RestartEvent();
});
