// ==EMEVD==
// @docs    er-common.emedf.json
// @compress    DCX_KRAK
// @game    Sekiro
// @string    "N:\\GR\\data\\Param\\event\\common_func.emevd\u0000N:\\GR\\data\\Param\\event\\common_macro.emevd\u0000\u0000\u0000\u0000\u0000\u0000"
// @linked    [0,82]
// @version    3.4.2
// ==/EMEVD==

$Event(0, Default, function() {
    RegisterBonfire(31070000, 31071950, 0, 0, 0, 5);
    InitializeEvent(0, 31072800, 0);
    InitializeEvent(0, 31072801, 0);
    InitializeEvent(0, 31072802, 0);
    InitializeEvent(0, 31042810, 0);
    InitializeEvent(0, 31042849, 0);
    InitializeEvent(0, 31072811, 0);
    InitializeCommonEvent(0, 900005610, 31071200, 100, 800, 0);
    InitializeCommonEvent(0, 90005261, 31070400, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070290, 31072290, 1077936128, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070291, 31072290, 1077936128, 1045220557, 0);
    InitializeCommonEvent(0, 90005250, 31070295, 31072295, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070296, 31072295, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070297, 31072297, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070298, 31072297, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070299, 31072297, 0, 0);
    InitializeCommonEvent(0, 90005251, 31070300, 1086324736, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070280, 31072290, 1077936128, 1056964608, 0);
    InitializeEvent(0, 31072280, 31070290);
    InitializeEvent(1, 31072280, 31070291);
    InitializeEvent(2, 31072280, 31070280);
    InitializeCommonEvent(0, 90005211, 31070250, 30000, 20000, 31072250, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070251, 30000, 20000, 31072251, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070252, 30000, 20000, 31072252, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070254, 30000, 20000, 31072254, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070255, 30000, 20000, 31072254, 0, 1056964608, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070257, 30000, 20000, 31072257, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070258, 30000, 20000, 31072258, 0, 0, 1, 0, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070200, 31072200, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070201, 30002, 20002, 31072201, 0, 1056964608, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005250, 31070210, 31072210, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070213, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070214, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070215, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070216, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070217, 31072400, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070218, 31072400, 1065353216, 0, 0);
    InitializeEvent(0, 31072213, 31070213, 31072213);
    InitializeEvent(1, 31072213, 31070214, 31072213);
    InitializeEvent(2, 31072213, 31070215, 31072213);
    InitializeEvent(3, 31072213, 31070216, 31072213);
    InitializeEvent(4, 31072213, 31070217, 31072213);
    InitializeCommonEvent(0, 90005261, 31070225, 31072225, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070226, 31072225, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070227, 31072225, 1065353216, 0, 0);
    InitializeEvent(0, 310722205, 31070225);
    InitializeEvent(1, 310722205, 31070226);
    InitializeEvent(2, 310722205, 31070227);
    InitializeEvent(0, 31072225, 31070225);
    InitializeEvent(1, 31072225, 31070226);
    InitializeEvent(2, 31072225, 31070227);
    InitializeCommonEvent(0, 90005261, 31070230, 31072230, 1084227584, 0, 0);
    InitializeEvent(1, 31072230, 31070231, 30001, 20001, 1065353216, 1053609165, 0, 0, 0, 0);
    InitializeEvent(2, 31072230, 31070232, 30001, 20001, 1065353216, 1058642330, 0, 0, 0, 0);
    InitializeEvent(3, 31072230, 31070233, 30001, 20001, 1065353216, 1061997773, 0, 0, 0, 0);
    InitializeEvent(4, 31072230, 31070234, 30001, 20001, 1065353216, 1056964608, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070350, 30001, 20001, 31072350, 1077936128, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070320, 30000, 30001, 0, 1086324736, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070321, 30000, 30001, 0, 1086324736, 0, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005211, 31070322, 30000, 30001, 0, 1082130432, 1050253722, 0, 0, 0, 0);
    InitializeCommonEvent(0, 90005646, 31070800, 31072840, 31072841, 31071840, 31072840, 1823);
});

$Event(50, Default, function() {
    InitializeCommonEvent(0, 90005261, 31070302, 31072302, 1065353216, 0, 0);
    InitializeCommonEvent(0, 90005261, 31070303, 31072302, 1065353216, 0, 0);
    InitializeEvent(0, 310722300, 31070302, 1092616192);
    InitializeEvent(1, 310722300, 31070303, 1093664768);
});

$Event(31072213, Restart, function(X0_4, X4_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    chrSp = (CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    WaitFor(
        (chrSp && EntityInRadiusOfEntity(X0_4, 10000, 2, 1))
            || (chrSp && InArea(10000, X4_4))
            || CharacterAIState(X0_4, AIStateType.Combat)
            || HasDamageType(X0_4, 0, DamageType.Unspecified)
            || CharacterHasStateInfo(X0_4, 436)
            || CharacterHasStateInfo(X0_4, 2)
            || CharacterHasStateInfo(X0_4, 5)
            || CharacterHasStateInfo(X0_4, 6)
            || CharacterHasStateInfo(X0_4, 260)
            || (CharacterHasSpEffect(X0_4, 481)
                && !CharacterHasSpEffect(X0_4, 90100)
                && !CharacterHasSpEffect(X0_4, 90110)
                && !CharacterHasSpEffect(X0_4, 90160))
            || (CharacterHasSpEffect(X0_4, 482)
                && !CharacterHasSpEffect(X0_4, 90100)
                && !CharacterHasSpEffect(X0_4, 90120)
                && !CharacterHasSpEffect(X0_4, 90160)
                && !CharacterHasSpEffect(X0_4, 90162))
            || (CharacterHasSpEffect(X0_4, 483)
                && !CharacterHasSpEffect(X0_4, 90100)
                && !CharacterHasSpEffect(X0_4, 90140)
                && !CharacterHasSpEffect(X0_4, 90160)
                && !CharacterHasSpEffect(X0_4, 90161))
            || (CharacterHasSpEffect(X0_4, 484)
                && !CharacterHasSpEffect(X0_4, 90100)
                && !CharacterHasSpEffect(X0_4, 90130)
                && !CharacterHasSpEffect(X0_4, 90161)
                && !CharacterHasSpEffect(X0_4, 90162))
            || (CharacterHasSpEffect(X0_4, 487)
                && !CharacterHasSpEffect(X0_4, 90100)
                && !CharacterHasSpEffect(X0_4, 90150)
                && !CharacterHasSpEffect(X0_4, 90160)));
    ClearSpEffect(X0_4, 8081);
    ClearSpEffect(X0_4, 8082);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(31072220, Restart, function(X0_4) {
    EndIf(CharacterDead(X0_4));
    WaitFor(
        ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && !CharacterHasSpEffect(X0_4, 8081)
            && !InArea(10000, 31072225));
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    RestartEvent();
});

$Event(310722205, Restart, function(X0_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    chrSp = CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710);
    chrSpArea = chrSp2 && CharacterHasSpEffect(X0_4, 8081) && InArea(10000, 31072225);
    chrSp2 |= cond
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    chrSp2 |= CharacterHasSpEffect(X0_4, 481)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90110)
        && !CharacterHasSpEffect(X0_4, 90160);
    chrSp2 |= CharacterHasSpEffect(X0_4, 482)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90120)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90162);
    chrSp2 |= CharacterHasSpEffect(X0_4, 483)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90140)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90161);
    chrSp2 |= CharacterHasSpEffect(X0_4, 484)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90130)
        && !CharacterHasSpEffect(X0_4, 90161)
        && !CharacterHasSpEffect(X0_4, 90162);
    chrSp2 |= CharacterHasSpEffect(X0_4, 487)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90150)
        && !CharacterHasSpEffect(X0_4, 90160);
    WaitFor(chrSpArea);
    ClearSpEffect(X0_4, 8081);
    ClearSpEffect(X0_4, 8082);
});

$Event(31072225, Restart, function(X0_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8092);
});

$Event(31072230, Restart, function(X0_4, X4_4, X8_4, X12_4, X16_4, X20_4, X24_4, X28_4, X32_4) {
    EndIf(SpecialStandbyEndedFlag(X0_4));
    if (X20_4 != 0) {
        DisableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, false);
    }
    ForceAnimationPlayback(X0_4, X4_4, true, false, false);
    chrSp = (CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
        || CharacterType(10000, TargetType.Alive)
        || CharacterType(10000, TargetType.GrayPhantom)
        || CharacterType(10000, TargetType.WhitePhantom);
    areaChrSp &= EntityInRadiusOfEntity(10000, X0_4, X12_4, 1)
        && CharacterBackreadStatus(X0_4)
        && (CharacterHasSpEffect(X0_4, 5080) || CharacterHasSpEffect(X0_4, 5450));
    if (!(X24_4 == 0 && X28_4 == 0 && X32_4 == 0)) {
        if (X24_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.Combat);
        }
        if (X28_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.ActiveAlert);
        }
        if (X32_4 != 0) {
            chr |= CharacterAIState(X0_4, AIStateType.PassiveAlert);
        }
        areaChrSp &= chr;
    }
L9:
    sp = CharacterHasSpEffect(X0_4, 481)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90110)
        && !CharacterHasSpEffect(X0_4, 90160);
    sp2 = CharacterHasSpEffect(X0_4, 482)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90120)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90162);
    sp3 = CharacterHasSpEffect(X0_4, 483)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90140)
        && !CharacterHasSpEffect(X0_4, 90160)
        && !CharacterHasSpEffect(X0_4, 90161);
    sp4 = CharacterHasSpEffect(X0_4, 484)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90130)
        && !CharacterHasSpEffect(X0_4, 90161)
        && !CharacterHasSpEffect(X0_4, 90162);
    sp5 = CharacterHasSpEffect(X0_4, 487)
        && !CharacterHasSpEffect(X0_4, 90100)
        && !CharacterHasSpEffect(X0_4, 90150)
        && !CharacterHasSpEffect(X0_4, 90160);
    areaChrSp &= chrSp;
    areaChrSpDmg = areaChrSp || dmgSp;
    dmgSp = HasDamageType(31070230, 0, DamageType.Unspecified)
        || HasDamageType(31070231, 0, DamageType.Unspecified)
        || HasDamageType(31070232, 0, DamageType.Unspecified)
        || HasDamageType(31070233, 0, DamageType.Unspecified)
        || HasDamageType(31070234, 0, DamageType.Unspecified)
        || sp
        || sp2
        || sp3
        || sp4
        || sp5;
    WaitFor(areaChrSpDmg);
    WaitFixedTimeSeconds(0.1);
    SetNetworkconnectedThisEventSlot(ON);
    SetSpecialStandbyEndedFlag(X0_4, ON);
    if (!(!CharacterHasSpEffect(X0_4, 5080) && !CharacterHasSpEffect(X0_4, 5450))) {
        WaitFixedTimeSeconds(X16_4);
        if (X20_4 != 0) {
            EnableCharacterGravity(X0_4);
            SetCharacterMaphit(X0_4, true);
        }
        ForceAnimationPlayback(X0_4, X8_4, true, false, false);
        EndEvent();
    }
L0:
    if (X20_4 != 0) {
        EnableCharacterGravity(X0_4);
        SetCharacterMaphit(X0_4, true);
    }
    EndEvent();
});

$Event(31072280, Restart, function(X0_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    WaitFor(
        (((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && EntityInRadiusOfEntity(X0_4, 10000, 2, 1))
            || CharacterAIState(X0_4, AIStateType.Combat)
            || HasDamageType(X0_4, 0, DamageType.Unspecified)
            || CharacterHasStateInfo(X0_4, 436)
            || CharacterHasStateInfo(X0_4, 2)
            || CharacterHasStateInfo(X0_4, 5)
            || CharacterHasStateInfo(X0_4, 6)
            || CharacterHasStateInfo(X0_4, 260));
    ClearSpEffect(X0_4, 8081);
    ClearSpEffect(X0_4, 8082);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(310722300, Restart, function(X0_4, X4_4) {
    EndIf(ThisEventSlot());
    SetSpEffect(X0_4, 8081);
    SetSpEffect(X0_4, 8082);
    WaitFor(
        ((CharacterType(10000, TargetType.BlackPhantom) && CharacterHasSpEffect(10000, 3710))
            || CharacterType(10000, TargetType.Alive)
            || CharacterType(10000, TargetType.GrayPhantom)
            || CharacterType(10000, TargetType.WhitePhantom))
            && InArea(10000, 31072302));
    WaitFixedTimeSeconds(X4_4);
    ClearSpEffect(X0_4, 8081);
    ClearSpEffect(X0_4, 8082);
    SetNetworkconnectedThisEventSlot(ON);
});

$Event(31072800, Restart, function() {
    EndIf(EventFlag(31070800));
    WaitFor(CharacterDead(31070800) && CharacterDead(31070801));
    HandleBossDefeatAndDisplayBanner(31070800, TextBannerType.EnemyFelled);
    //boss rewards (3 bonus items + guaranteed flag)
    InitializeCommonEvent(0,90001033,1049304182,1049304058,-1,1049304004,1049304772,1049304773,1049304774,1049304775,1049305164,1049305166,1049305169,1049305175,1049300182);
    WaitFixedTimeSeconds(6);
    WarpPlayer(11, 10, 0, 0, 11102021, 0);
});

$Event(31072801, Restart, function() {
    EndIf(EventFlag(31070800));
    WaitFor(CharacterHPValue(31070800) <= 0);
    WaitFixedTimeSeconds(4);
    PlaySE(31070800, SoundType.SFX, 888880000);
});

$Event(31072802, Restart, function() {
    EndIf(EventFlag(31070800));
    WaitFor(CharacterHPValue(31070801) <= 0);
    WaitFixedTimeSeconds(4);
    PlaySE(31070801, SoundType.SFX, 888880000);
});

$Event(31042810, Restart, function() {
    if (EventFlag(31070800)) {
        DisableCharacter(31070800);
        DisableCharacter(31070801);
        DisableCharacterCollision(31070800);
        DisableCharacterCollision(31070801);
        ForceCharacterDeath(31070800, false);
        ForceCharacterDeath(31070801, false);
        EndEvent();
    }
L0:
    ForceAnimationPlayback(31070801, 30009, true, false, false);
    DisableCharacterAI(31070800);
    DisableCharacterAI(31070801);
    SetSpEffect(31070800, 8092);
    SetSpEffect(31070801, 8092);
    WaitFor(EventFlag(31072805) && InArea(10000, 31072800));
    SetNetworkconnectedEventFlagID(31070801, ON);
L2:
    DisplayBossHealthBar(Enabled, 31070800, 0, 903810310);
    DisplayBossHealthBar(Enabled, 31070801, 1, 903810311);
    EnableCharacterAI(31070800);
    EnableCharacterAI(31070801);
    SetNetworkUpdateRate(31070800, true, CharacterUpdateFrequency.AlwaysUpdate);
    SetNetworkUpdateRate(31070801, true, CharacterUpdateFrequency.AlwaysUpdate);
    WaitFixedTimeSeconds(2);
    ForceAnimationPlayback(31070801, 20029, false, false, false);
});

$Event(31072811, Restart, function() {
    EndIf(EventFlag(31070800));
    WaitFor(CharacterDead(31070800) || CharacterDead(31070801));
    SetEventFlagID(31072842, ON);
});

$Event(31042849, Restart, function() {
    InitializeCommonEvent(0, 9005800, 31070800, 31071800, 31072800, 31072805, 31075800, 10000, 0, 0);
    InitializeCommonEvent(0, 9005801, 31070800, 31071800, 31072800, 31072805, 31072806, 10000);
    InitializeCommonEvent(0, 9005811, 31070800, 31071800, 5, 0);
    InitializeCommonEvent(0, 9005822, 31070800, 931000, 31072805, 31072806, 0, 31072842, 0, 0);
});
